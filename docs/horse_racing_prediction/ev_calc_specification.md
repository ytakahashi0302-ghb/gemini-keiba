# 競馬期待値（EV）算出モデル Ver 3.0 統合仕様書（Webアプリ実装用）

## 1. 概要
本モデルは、競走馬の過去データおよびコースの物理的プロファイルから「総合能力スコア（$S_i$）」を算出し、それをSoftmax関数によって「推定勝率（$P_i$）」へ変換した上で、実際のオッズと掛け合わせて「真の期待値（$EV_i$）」を導き出す統合アルゴリズムである。
Ver 3.0は、アプリ実装時に発生する「非現実的な大穴ばかりを推奨するバグ」を防止するための確率変換ロジックや、各種のペナルティ相殺処理（セーフティネット）をすべて包含した完全版仕様である。

---

## 2. フェーズ1：総合能力スコア（$S_i$）の基本算出
対象馬 $i$ の総合能力スコア $S_i$ を算出する。この時点のスコアはまだ期待値（EV）ではなく、純粋な「強さの指標」である。

$$S_i = w_1 \cdot Z(T_i) + w_2 \cdot Z(F_i) + w_3 \cdot C_i + w_{4,i} \left( \frac{1}{R_i} \right) + w_5 \cdot J_i + w_6 \cdot W_i$$

### 2.1. 各変数の定義とZスコアのクリッピング（外れ値対策）
* **$T_i$（走破タイムスコア）**: 過去の持ち時計のZスコア。値が小さい（速い）ほど高評価となるよう $\bar{T} - T_i$ で計算する。
* **$F_i$（上り3ハロンスコア）**: 終盤の末脚の鋭さのZスコア。
  * **【実装要件】異常値の除外**: $Z(T_i)$ および $Z(F_i)$ は、1回のフロック（まぐれ）によるスコア爆発を防ぐため、必ず $[-3.0, 3.0]$ の範囲でクリッピング処理（丸め処理）を行うこと。
* **$R_i$（直近実績スコア）**: 直近3走の平均着順。値が小さい（1着に近い）ほど好調なため、逆数 $1/R_i$ を取る。
* **$J_i$（騎手ファクター）**: 当該コースでの勝率や乗り替わりリスクの数値化。
* **$W_i$（直前コンディション）**: 調教評価および当日の馬体重増減による補正値。
* **$w_1 \sim w_6$（基本ウェイト）**: 各変数の重み付け係数。
  * **【推奨初期値】**: $w_1=0.20, w_2=0.25, w_3=0.30, w_4=0.15, w_5=0.05, w_6=0.05$

---

## 3. フェーズ2：コースプロファイルと枠順ペナルティ相殺（$C_i$）
レースが行われる競馬場の物理的特徴と枠順バイアスから、環境合致度 $C_i$ を算出する。

$$C_i = \alpha \cdot S_{straight} + \beta \cdot H_{slope} + \gamma \cdot R_{corner} + \delta \cdot B'_{draw}$$

### 3.1. 基礎能力値 $A_i$ によるペナルティ相殺ロジック
地力の抜けた実績馬が枠順等の不利で過剰に評価を落とすことを防ぐ。
対象馬の過去の最大実績に応じた係数 $A_i$ （G1馬=0.8、重賞馬=0.5、条件馬=0.0）を設定し、枠順バイアス $B_{draw}$ に対して適用する。

$$B'_{draw} = \begin{cases} B_{draw} \times (1 - A_i) & \text{if } B_{draw} < 0 \text{ (枠が不利な場合)} \\ B_{draw} & \text{otherwise (枠が有利な場合)} \end{cases}$$

---

## 4. フェーズ3：実績ペナルティの動的緩和（過学習防止）
「トラックバイアスに完全に合致しているが、近走の着順が悪い馬」の取りこぼしを防ぐための条件分岐ロジック。
フェーズ2で算出したコース適性 $C_i$ が閾値 $\theta$（上位15%相当など）を超えた場合、実績ウェイト $w_{4,i}$ を強制減衰させる。

$$w_{4,i} = \begin{cases} w_4 \times 0.2 & \text{if } C_i \ge \theta \\ w_4 & \text{otherwise} \end{cases}$$

---

## 5. フェーズ4：確率変換と真の期待値（$EV_i$）算出
算出した総合能力スコア $S_i$ を Softmax関数で「推定勝率 $P_i$」に変換し、実際のオッズ $O_i$ と掛け合わせて最終的な期待値を導き出す。**（※大穴暴走バグ防止のコアロジック）**

### 5.1. 推定勝率 $P_i$ の算出（Softmax関数）
出走頭数 $N$ に対し、各馬の勝率の合計が $1.0$（100%）になるよう変換する。

$$P_i = \frac{\exp(S_i / \tau)}{\sum_{j=1}^{N} \exp(S_j / \tau)}$$

* **$\tau$（温度パラメータ）のチューニング**: 
  $\tau$ は分散を調整する値。$\tau=1.0$ だとスコア1位の勝率が極端に高く（例: 95%）算出されてしまうため、競馬特有の不確実性（ノイズ）を表現するために **$\tau = 1.5 \sim 2.0$** に設定する。これにより「本命馬30%、穴馬2%」といった現実的な勝率分布が生成される。

### 5.2. 真の期待値 $EV_i$ の算出
$$EV_i = P_i \times O_i$$

* **判定基準**: $EV_i > 1.0$ を超える馬は「統計的に見て、オッズの旨味がある（長期的に買えばプラスになる）」と判定される。

---

## 6. フェーズ5：ポートフォリオ（買い目）自動生成ロジック
アプリが最終的な買い目を出力する際のアルゴリズム。

1. **絶対軸の選定**: $P_i$（推定勝率）が上位3頭以内で、かつ $EV_i \ge 0.9$ の馬。（勝率を無視してEVだけで選ぶと大穴が選ばれるため、必ず勝率上位から選定する）
2. **高EV伏兵（ヒモ穴）の選定**: $P_i$ は低くても、オッズの歪みにより $EV_i \ge 1.2$ を超える馬。
3. **危険な人気馬（消し）**: オッズが低い（単勝5倍以下など）にも関わらず、$EV_i < 0.8$ の馬。

* **戦略A（バランス型）**: 絶対軸から、勝率上位馬および高EV伏兵へ流す馬連・ワイド。
* **戦略B（ハイリスク型）**: 絶対軸を1・2着に固定し、高EV伏兵を3着に散りばめる三連単フォーメーション。