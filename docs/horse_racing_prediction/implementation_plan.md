# EV Model Ver 3.0 実装計画

ご提供いただいた「競馬期待値（EV）算出モデル Ver 3.0 統合仕様書」に基づき、Pythonスクレイパー内の期待値計算アルゴリズムを根本から改修・統合するための実装計画です。

## User Review Required
以下のアルゴリズム変更で実装を進めます。Softmax関数の温度パラメータ $\tau$ は、仕様書の推奨値から中央の `1.75` （または `1.8`）を初期値として設定する予定ですが、問題ないでしょうか？

## Proposed Changes

### Backend
#### [MODIFY] scraper.py

* `calculate_expected_values` 関数の全面改修：
  * **フェーズ1：総合能力スコア（$S_i$）の算出とZスコアクリッピング**
    * 係数ウェイトを仕様書通りに更新 ($w_1=0.20, w_2=0.25, w_3=0.30, w_4=0.15, w_5=0.05, w_6=0.05$)。
    * 走破タイム $T_i$ と 上り3F $F_i$ をZスコア（標準化）し、`[-3.0, 3.0]` の範囲でクリッピング。欠損値がある場合はペナルティとしてZスコア `-0.5` を付与。
    * これらを掛け合わせて純粋な能力スコア $S_i$ を全頭に事前計算する。
  * **フェーズ4：Softmax関数による勝率への変換 (Ver 3.1 修正)**
    * 各馬の純粋能力スコア $S_i$ の分散をレース内で正規化（Zスコア化）したものを $S_{zscore}$ とします。
    * これにより、スコアのクラスタリングによる勝率の極端な平準化を防ぎます。
    * $P_i = \frac{\exp(S_{zscore} / \tau)}{\sum \exp(S_{zscore} / \tau)}$
    * 温度パラメータ ($\tau$): **1.5** に修正。また、最低保証勝率を **0.1% (0.001)** に修正し、よりユーザーの意図に沿った勝率分布を見直しました。オッズ $O_i$ を掛け合わせ、$EV_i = P_i \times O_i$ を計算する。
  * **フェーズ5：ポートフォリオ（買い目）自動生成と分類ロジック**
    * `絶対軸`：勝率 $P_i$ が全体トップ3以内、かつ $EV_i \ge 0.9$ の馬。
    * `高EV伏兵`：勝率にかかわらず $EV_i \ge 1.2$ の馬。
    * `危険な人気馬`：単勝オッズ $5.0$ 以下、かつ $EV_i < 0.8$ の馬。
    * `一般馬`：その他の馬。
    * **[NEW] ポートフォリオ生成 (`generate_portfolios`) の刷新**:
      * 「絶対軸」をベースとし、戦略A（バランス型：馬連・ワイド等）、戦略B（ハイリスク型：3連複・3連単等）の買い目を作成。
      * 意味をなさない「単純な券種別トップ3（`generate_top3_by_bet_type`）」の出力を廃止し、これに依存していたフロントエンドの補充ロジックも修正。

#### [MODIFY] frontend/js/app.js
* 「券種別 EVトップリスト」の描画（`renderTop3Bets` 等）を削除し、純粋に「絶対軸」ベースのポートフォリオシミュレータにフォーカスするUIへ変更。
* 予算拡張時の買い目補充ロジックを修正（top3_betsからではなく、ポートフォリオプール内での分配に専念）。

#### [NEW] GitHub Push
* ローカルでのテスト確認後、全ての変更をローカルリポジトリにコミットし、GitHubの `main` ブランチへPushする。

## Verification Plan
* `scraper.py` を再実行し `data.json` を生成する。
* ブラウザダッシュボード（`localhost`）を開き、UIから「券種別 EVトップリスト」が消え、シミュレータのみが表示されているか確認。
* シミュレータの買い目が「絶対軸」を活用したもの（馬単、3連複などで軸指定されているか）になっていることを検証する。
* `git commit` 及び `git push` が成功することを確認する。
