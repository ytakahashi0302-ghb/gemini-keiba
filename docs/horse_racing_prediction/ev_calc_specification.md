# 競馬期待値（EV）算出モデル Ver 3.0 詳細仕様書

## 1. 概要
本仕様書は、競馬予測システムにおいて各馬の「勝率」および「期待値（EV）」を算出するコアロジック（EV Ver 3.0）を定義する。
本システムは、過去の走破タイム、上がり3ハロン、コース適性、直近成績、騎手、馬体重変動などの要素から「総合能力スコア（$S_i$）」を算出し、Softmax関数によって現実的な「推定勝率（$P_i$）」へ変換した上で、オッズを用いて「期待回収率（$EV_i$）」を求める。

また、算出したEVをもとに「絶対軸」「高EV伏兵」「危険な人気馬」といったクラシフィケーションを行い、自動的にポートフォリオ（買い目）を生成する。

---

## 2. 総合能力スコア（$S_i$）の算出ロジック

各馬 $i$ に対して以下の式でスコア $S_i$ を計算する。

$$S_i = w_1 \cdot T_{zscore,i} + w_2 \cdot F_{zscore,i} + w_3 \cdot C_i + w'_{4,i} \cdot R_{score,i} \times 10 + w_5 \cdot J_{score,i} + w_6 \cdot W_{score,i}$$

現在の重み付け係数（Weights）のデフォルト値は以下の通り：
* $w_1 = 0.20$ （持ち時計）
* $w_2 = 0.25$ （上がり3F）
* $w_3 = 0.30$ （コース適性・枠順）
* $w_4 = 0.15$ （直近成績）※動的に変動
* $w_5 = 0.05$ （騎手）
* $w_6 = 0.05$ （コンディション/馬体重）

### 2.1 持ち時計スコア（$T_{zscore,i}$）
過去の走破タイム（$T_i$）を基準に正規化（Zスコア化）する。ここではタイムが短い（速い）ほどプラス評価とするため、以下のように計算する。

1. 当該レースの距離に合わせて、各馬の過去の走破タイムを補正した推定ベストタイム（$best\_time\_est$）を求める。
2. 出走全馬の $best\_time\_est$ の平均値（$\mu_T$）と標準偏差（$\sigma_T$）を計算する。
3. $T_{zscore,i} = \frac{\mu_T - best\_time\_est_i}{\sigma_T}$
4. 外れ値防止のため、算出した値は $[-3.0, 3.0]$ の範囲でクリッピングする。
5. **欠損値補完**: 過去の走破タイムが存在しない馬（初出走など）には、ペナルティとして一律 `-0.5` を与える。

### 2.2 上がり3ハロンスコア（$F_{zscore,i}$）
直近の上がり3ハロン（$last\_3f$）を正規化する。計算アプローチは持ち時計スコアと同様（値が小さいほど速い）。

1. 出走全馬の上がり3Fの平均値（$\mu_F$）と標準偏差（$\sigma_F$）を計算する。
2. $F_{zscore,i} = \frac{\mu_F - last\_3f_i}{\sigma_F}$
3. $[-3.0, 3.0]$ でクリッピング。
4. **欠損値補完**: データがない馬には、一律 `-0.5` のペナルティ。

---

## 3. コース適性と枠順バイアス（$C_i$）

コース形態（直線距離、坂の有無、コーナー形状）に対する適性と、当日の枠順による有利不利（枠順バイアス）を総合した指標である。

$$C_i = (\alpha \cdot S_{straight}) + (\beta \cdot H_{slope}) + (\gamma \cdot R_{corner}) + (\delta \cdot B'_{draw}) + W_{bonus}$$

### 3.1 基礎コース適性係数 ($\alpha, \beta, \gamma$)
レース条件（距離や競馬場）に応じて要求されるコース適性の重みを動的に決定する。
* $\alpha$: 直線要素。マイル競技（1600m等）では `1.0`、それ以外は `0.8` とする。
* $\beta$: 勾配（坂）要素。坂のキツい「中山」等では `1.2`、それ以外は `0.8`。
* $\gamma$: コーナー要素。（現状はデフォルト `1.0`）

### 3.2 枠順バイアスの地力相殺ロジック（$B'_{draw}$）
枠順による有利不利（$B_{draw}$）を算出する。例えば、小回り短距離（例：中山・阪神の1200m）では内枠（1〜4枠）にボーナス `+0.5`、外枠（7〜8枠）にペナルティ `-0.3` を与える。

ここで、地力のある馬が枠順の不利で過剰に評価を下げるのを防ぐため、当該馬の過去の最大実績（$A_i$：G1級なら0.8など）を用いてペナルティのみを緩和（相殺）する。
* 不利（$B_{draw} < 0$）の場合： $B'_{draw} = B_{draw} \times (1.0 - A_i)$
* 有利またはニュートラルの場合： $B'_{draw} = B_{draw}$

### 3.3 馬体重による固有ボーナス（$W_{bonus}$）
500kgを超える大型馬は坂に強いとみなし、勾配係数への適性ボーナスとして $W_{bonus} = 0.2 \times H_{slope}$ を付与する。

---

## 4. 直近成績、騎手、コンディションの補正

### 4.1 直近成績スコア（$R_{score,i}$）と過学習防止
1. 直近3走の平均着順を $r_i$ とする。
2. 基本スコアは $R_{score,i} = \frac{1}{r_i}$ とする。実績がない場合は平均8着相当（$1/8.0$）とする。
3. **過学習防止（環境合致の一発逆転）**:
   コース適性 $C_i$ が閾値 $\theta = 1.5$ 以上の馬は、「近走の着順は悪いが、今回の条件に特大の適性がある」と判断し、直近成績の悪影響を緩和するため $w_{4}$ を大きく下げる。
   * もし $C_i \ge 1.5$ なら、$w'_{4,i} = w_4 \times 0.2$
   * そうでなければ、$w'_{4,i} = w_4$

### 4.2 騎手スコア（$J_{score,i}$）
特定のトップジョッキー（例：ルメール、川田）が騎乗する場合にボーナスを与える。
* 指定騎手の場合： `1.0`
* その他の騎手の場合： `0.5`

### 4.3 コンディション/馬体重増減スコア（$W_{score,i}$）
前走からの馬体重変動（$weight\_change$）を評価する。
* 極端な増減（`-10kg` 以下または `+15kg` 以上）がある場合のみ、ペナルティとして `0.5` とする。
* それ以外（通常の範囲や増減なし）は `1.0`。

---

## 5. 推定勝率（$P_i$）と期待回収率（$EV_i$）の算出

### 5.1 Softmax関数による推定勝率変換
各馬の能力スコア $S_i$ を、レース内の他馬との相対評価に変換し、合計が $1.0$（100%）となる勝率確率 $P_i$ を求める。特定馬への極端な確率の偏りを防ぐため、Zスコア化および温度パラメータ（$\tau=1.5$）を用いる。

1. レース内の $S_i$ の平均（$\mu_S$）と標準偏差（$\sigma_S$）を求める。
2. $S_{zscore,i} = \frac{S_i - \mu_S}{\sigma_S}$
3. $P_i = \frac{\exp(S_{zscore,i} / \tau)}{\sum_{j=1}^{N} \exp(S_{zscore,j} / \tau)}$
4. **最低保証勝率**: どんなに能力値が低い馬でも事故などの可能性を考慮し、 $P_i$ は最低 `0.001` (0.1%) を保証する。
5. （外部データ連携ボーナス）：競馬ラボ連携等で直近上がり3Fが34.0未満の場合は1.05倍、35.0未満の場合は1.02倍の係数を $P_i$ にかけ算して最終勝率とする。

### 5.2 真の期待値（$EV_i$）の算出
算出した推定勝率 $P_i$ に対し、実際のオッズ $O_i$ を掛けて期待回収率を求める。
$$EV_i = P_i \times O_i$$

---

## 6. クラシフィケーションとポートフォリオ（買い目）生成

各馬を $EV_i$ と $P_i$、およびオッズを用いて以下の3カテゴリに分類（Classification）する。

* **絶対軸**: $P_i$ が上位3頭以内で、かつ $EV_i \ge 0.9$
* **高EV伏兵**: $EV_i \ge 1.2$ （一発逆転の旨味がある馬）
* **危険な人気馬**: $O_i \le 5.0$ （単勝5倍以下）かつ $EV_i < 0.8$

この分類をもとに、システムは以下の2つの戦略でポートフォリオ（予想買い目リスト）を自動生成する。
※オッズ情報が完全でない場合（予想オッズなどのフォールバック時）、買い目作成時の連携オッズには疑似計算を使用する。

### 戦略A（堅実バランス型）
* **絶対軸** から、勝率上位7頭に向けて推奨する。
* 券種：単勝、ワイド、馬連。

### 戦略B（ハイリスク・歪み狙い型）
* **絶対軸** を1着固定、または軸とし、**高EV伏兵**（不在の場合はオッズ10倍〜50倍の中穴）へ向けて推奨する。
* 券種：伏兵の単勝、馬単、3連複、3連単。