# 競馬期待値（EV）算出モデル Ver 2.2 仕様書

## 1. 概要
本モデルは、過去の走破タイム、上りタイム、コース適性、直近実績、騎手、直前コンディションの6つの変数を統合し、競走馬の総合期待値（EV）スコアを算出するアルゴリズムである。
Ver 2.2では、新たに「基礎能力値（クラス実績）」によるペナルティ相殺ロジックを実装し、地力の抜けた実績馬が枠順等の不利で過剰に評価を落とす「過小評価のバグ」を防止する仕様となっている。

## 2. 全体評価式（メイン関数）
対象馬 $i$ の総合期待値スコア $S_i$ を以下の式で算出する。値が高いほど「期待値が高い（買うべき馬）」と判定する。

$$S_i = w_1 \left( \frac{\bar{T} - T_i}{\sigma_T} \right) + w_2 \left( \frac{\bar{F} - F_i}{\sigma_F} \right) + w_3 C_i + w_{4,i} \left( \frac{1}{R_i} \right) + w_5 J_i + w_6 W_i$$

### 2.1. 各変数の定義
* $T_i$ **（走破タイムスコア）**: 過去の持ち時計をコース基準に正規化。値が小さい（速い）ほど高評価となるよう平均から減算。
* $F_i$ **（上り3ハロンスコア）**: 終盤の末脚の鋭さを正規化。
* $C_i$ **（コース・枠順バイアス適性）**: 後述の「コースプロファイル関数」で算出される、当該レース特有の環境合致度。
* $R_i$ **（直近実績スコア）**: 直近3走の平均着順。逆数 $1/R_i$ を取ってスコア化。
* $J_i$ **（騎手ファクター）**: 当該コースでの勝率や、乗り替わりリスクの有無を数値化したスコア。
* $W_i$ **（直前コンディション）**: 調教タイムの評価値および、当日の馬体重増減によるペナルティ/ボーナス補正値。
* $w_1 \sim w_6$ **（基本ウェイト）**: 各変数の重み付け係数。

---

## 3. 【Ver 2.2 コアロジック】コースプロファイルと「地力によるペナルティ相殺」
レースが行われる競馬場の物理的な特徴と枠順バイアスを計算する際、新たに「基礎能力値 $A_i$」を導入し、枠順の不利を地力でカバーする相殺ロジックを適用する。

### 3.1. 基礎能力値 $A_i$ の定義
対象馬の過去の最大実績（クラス）に応じた係数 $A_i$ （$0.0 \le A_i \le 1.0$）を設定する。
* G1勝利レベル: $A_i = 0.8 \sim 1.0$
* G2/G3勝利レベル: $A_i = 0.5 \sim 0.7$
* 条件戦レベル: $A_i = 0.0$

### 3.2. ペナルティ相殺付き コース適性関数 $C_i$
$$C_i = \alpha \cdot S_{straight} + \beta \cdot H_{slope} + \gamma \cdot R_{corner} + \delta \cdot B'_{draw}$$

枠順バイアス $B_{draw}$ （内枠有利・外枠不利などの生データ）に対し、以下の条件分岐で相殺済みバイアス $B'_{draw}$ を算出する。

$$B'_{draw} = \begin{cases} B_{draw} \times (1 - A_i) & \text{if } B_{draw} < 0 \text{ (枠順が不利な場合)} \\ B_{draw} & \text{otherwise (枠順が有利な場合)} \end{cases}$$

* **効果**: G1馬（$A_i = 0.8$）が大外枠で大きなマイナス判定（例：$B_{draw} = -10$）を受けた場合でも、$10 \times (1 - 0.8) = -2$ となり、**「枠の不利は受けるが、地力で80%カバーできる」**というリアルな評価額に自動補正される。

---

## 4. 【Ver 2.1 継承ロジック】実績ペナルティの動的緩和
トラックバイアスに完全合致する穴馬の取りこぼしを防ぐため、コース適性 $C_i$ が閾値 $\theta$ を超えた場合、直近実績のウェイト $w_{4,i}$ を減衰させる。

$$w_{4,i} = \begin{cases} w_4 \times 0.2 & \text{if } C_i \ge \theta \\ w_4 & \text{otherwise} \end{cases}$$

---

## 5. 実装ガイドライン（Excel / スプレッドシート用）

### 5.1. ペナルティ相殺ロジック（3章）の関数記述例
枠順バイアスのセルを計算する際、以下の `IF` 関数を挟む。
`=IF( [B_drawのセル] < 0, [B_drawのセル] * (1 - [A_iのセル]), [B_drawのセル] )`

### 5.2. ポートフォリオ構築ルール
1. **戦略A（バランス型）**: $S_i$ 最上位の絶対軸から上位馬へ流すワイド・馬連。
2. **戦略B（ハイリスク・ハイリターン型）**: $S_i$ 上位馬を頭に固定し、高EV伏兵をヒモに置く三連単フォーメーション。