# 競馬ダッシュボード Ver 2.2 実装計画

## 全体概要
競走馬の能力（基礎能力値）や過去実績をより正確にスコア化する「EV算出モデル Ver 2.2」の実装と、予想があたっていたかをダッシュボード上で視認できる「決着済みレースの表示機能」を追加します。

## ユーザーレビューが必要な項目
1. **期待値（EV）算出における過大評価の抑制**:
   人気薄（オッズが高い馬）が過剰にシステムから選ばれてしまう現象を抑えるため、ベース勝率の計算ロジック（`base_win_prob` や `s_i` から勝率への変換）に補正スケールを適用します。これにより、極端な大穴のEV値が異常に高くなることを防ぎます。

---

## 提案される変更 (Proposed Changes)

### 1. Model Ver 2.2: 基礎能力値とペナルティ相殺の実装
*   実績馬の大外枠などの不利を地力で補う「基礎能力値（$A_i$）」ロジックを実装します。

#### [MODIFY] [scraper.py](file:///c:/Users/green/Documents/workspaces/horse_racing_app/scraper.py)
*   **$A_i$ の取得**: 過去走のHTML要素 `.Data02` と `.Num` をスクレイピングし、過去の最高勝利クラス（G1, G2/G3, その他）を判定して $A_i$ (0.0〜1.0) を設定します。
*   **$B'_{draw}$ の算出**: 該当馬の枠順バイアス $B_{draw}$ がマイナスの場合、公式に則り `$B_{draw} \times (1 - A_i)$` を適用してコース適性 $C_i$ を計算します。
*   **期待値計算式の補正**: オッズ計算に回す前の `win_prob` 変換において、Softmaxや調整係数を見直し、大穴馬のスコアインフレを抑制します。

---

### 2. 決着済みレースのスクレイピング・UI表示
*   過去のレース（オーシャンSなど）について、Netkeibaの `result.html` から確定した着順と配当金を取得し、UI上に結果を表示させます。

#### [MODIFY] [scraper.py](file:///c:/Users/green/Documents/workspaces/horse_racing_app/scraper.py)
*   スクレイピング開始時に、対象レースの `result.html` が存在し、結果が出ているかを判定するロジック（`race_info["status"] = "finished"`）を追加します。
*   結果が出ている場合は、1着〜3着の馬番と人気、および各券種の配当データを取得してJSONに格納します。

#### [MODIFY] [frontend/js/app.js](file:///c:/Users/green/Documents/workspaces/horse_racing_app/frontend/js/app.js)
*   サイドバーのリストで、決着済みのレースに「**決着済み**」バッジを付与します。
*   ダッシュボード上部に、そのレースの実際のTop3着順を表示するエリアを追加し、AIの期待値予想（S_i上位馬など）と比較できるようにします。

---

## 確認計画 (Verification Plan)
1. **Ver 2.2 再計算テスト**: ローカルでスクレイパーを実行し、「オーシャンS」の出力データで、上位人気の基礎能力（$A_i$）が正しく相殺に反映されているか、異常な高EV値が出ていないかを確認。
2. **レース結果の検証**: 終了済みレースを選択した際、フロントエンドに「実際の決着順位（1着〜3着）」と配当金が表示されるかをブラウザテスト。も問題ありません）

### 🚀 Netlify公開に向けたユーザー様側での作業手順
AI側での実装（整理・GitHub連携準備）が完了後、ユーザー様には以下の手順を実施していただきます。

1.  **GitHubへのプッシュ**:
    *   GitHubアカウントで新しいリポジトリを作成し、このローカルフォルダの変更をコミット＆プッシュします。
2.  **Netlifyとの連携**:
    *   Netlifyのアカウントにログインし、「Add new site」>「Import an existing project」を選択します。
    *   連携したGitHubリポジトリを選択します。
    *   ビルド設定（**Publish directory**）を `frontend` と入力し、デプロイを実行します。

## User Review Required

> [!TIP]
> **GitHub Actionsによる週末自動更新機能**を実装してよろしいでしょうか？  
> 実装を希望される場合は、自動化スクリプトの設定ファイルを作成し、プロジェクトをGitリポジトリとして初期化 (`git init` 〜 コミット準備) いたします。
